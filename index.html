<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆå“¡æ´»å‹•è¨˜éŒ„ç³»çµ± - æ”¯æ´æ›´åç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --accent: #d35400; --sidebar-width: 220px; --book-width: 800px; }
        body { background-color: #1a1a1a; margin: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; color: #eee; }

        .sidebar { width: var(--sidebar-width); background: #252525; color: white; display: flex; flex-direction: column; padding: 20px 15px; border-right: 1px solid #333; z-index: 100; }
        .member-list { flex-grow: 1; overflow-y: auto; margin: 15px 0; }
        .member-item { 
            padding: 10px; margin: 5px 0; background: #333; border-radius: 8px; 
            cursor: grab; transition: 0.2s; font-size: 14px; text-align: center;
            user-select: none; /* é˜²æ­¢é›™æ“Šé¸å–åˆ°æ–‡å­— */
        }
        .member-item.active { background: var(--accent); font-weight: bold; }
        
        .add-area { display: flex; flex-direction: column; gap: 8px; }
        .add-area input { padding: 8px; border-radius: 5px; border: none; background: #444; color: white; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #111; position: relative; }
        .export-gate { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; opacity: 0; transition: 0.3s; z-index: 2000; }
        .export-gate:hover { opacity: 1; }

        .toolbar { margin-bottom: 20px; display: flex; gap: 10px; }

        .postcard-container {
            width: var(--book-width); height: 500px; background: #000; border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center; border: 1px solid #333;
        }
        .full-img { width: 100%; height: 100%; object-fit: contain; }

        .name-tag { position: absolute; bottom: 15px; left: 15px; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(5px); padding: 4px 12px; border-radius: 20px; font-size: 12px; color: white; border: 1px solid rgba(255,255,255,0.2); }
        .page-info { position: absolute; top: 15px; right: 15px; background: rgba(0, 0, 0, 0.5); padding: 4px 12px; border-radius: 20px; font-size: 12px; }

        .nav-controls { display: flex; align-items: center; gap: 20px; margin-top: 20px; position: relative; width: var(--book-width); justify-content: center; }
        .desc-area { width: var(--book-width); margin-top: 20px; }
        .desc-area textarea { width: 100%; height: 80px; padding: 15px; border-radius: 12px; background: #222; border: 1px solid #333; color: #ccc; resize: none; font-size: 14px; }

        .btn { padding: 8px 18px; cursor: pointer; border-radius: 50px; border: none; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .btn-nav { background: #333; color: white; border: 1px solid #444; }
        .lock-text-btn { position: absolute; right: 0; bottom: 0; background: transparent; color: #444; font-size: 11px; cursor: pointer; border: none; padding: 5px; }

        body.is-locked .toolbar, body.is-locked .add-area, body.is-locked #lockBtn, body.is-locked .import-btn, body.is-locked .share-btn, body.is-locked button[onclick*="deleteCurrentPhoto"] { display: none !important; }
        body.is-locked .member-item { cursor: pointer; }
        body.is-locked textarea { background: transparent; border: 1px solid transparent; color: #999; cursor: default; }
    </style>
</head>
<body id="mainBody">

    <div class="export-gate">
        <button class="btn share-btn" style="background:#2980b9; color:white;" onclick="exportJSON()">ğŸ“¤ åˆ†äº«æ‰“åŒ…æª”</button>
        <button class="btn import-btn" style="background:#8e44ad; color:white;" onclick="document.getElementById('importInp').click()">ğŸ“¥ åŒ¯å…¥æ‰“åŒ…æª”</button>
        <input type="file" id="importInp" accept=".json" style="display:none" onchange="importJSON(this)">
        <button class="btn" style="background:#27ae60; color:white;" onclick="exportPDF()">ğŸ–¨ï¸ ç”¢å‡º PDF</button>
    </div>

    <div class="sidebar">
        <h3 style="font-size:16px; color:var(--accent); text-align:center;">åƒè³½è€…</h3>
        <p style="font-size: 10px; color: #666; text-align: center; margin-top: -10px;"></p>
        <div class="member-list" id="memberList"></div>
        <div class="add-area">
            <input type="text" id="newName" placeholder="æ–°æˆå“¡åç¨±...">
            <button class="btn" style="background:var(--accent); color:white;" onclick="addNewMember()">ï¼‹ æ–°å¢æˆå“¡</button>
        </div>
    </div>

    <div class="main-content">
        <div class="toolbar">
            <button class="btn" style="background:#444; color:white;" onclick="document.getElementById('imgInp').click()">ï¼‹ åŒ¯å…¥ç…§ç‰‡</button>
            <input type="file" id="imgInp" accept="image/*" style="display: none;" multiple onchange="handleBatchUpload(this)">
        </div>

        <div class="postcard-container">
            <div id="photoContent" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                <span style="color:#444;">SELECT MEMBER</span>
            </div>
            <div class="name-tag" id="canvasNameTag">NAME</div>
            <div class="page-info" id="pageNumber">0 / 0</div>
        </div>

        <div class="nav-controls">
            <button class="btn btn-nav" id="prevBtn" onclick="changePhotoIdx(-1)">PREV</button>
            <button class="btn" style="background:transparent; color:#666; font-size:11px;" onclick="deleteCurrentPhoto()">REMOVE PHOTO</button>
            <button class="btn btn-nav" id="nextBtn" onclick="changePhotoIdx(1)">NEXT</button>
            <button class="lock-text-btn" id="lockBtn" onclick="finalLock()">[ ğŸ”’ FINAL LOCK ]</button>
        </div>

        <div class="desc-area"><textarea id="textInp" placeholder="æˆå“¡ä»‹ç´¹..." oninput="syncMemberDesc()"></textarea></div>
    </div>

    <div id="print-zone" style="position: absolute; top: 0; left: -5000px; width: 900px;"></div>

    <script>
        let curMemId = '';
        let curPhotoIdx = 0;
        let isLocked = false;
        let db = {};
        let sortable;

        window.onload = () => {
            const savedData = localStorage.getItem('member_records_db');
            const savedOrder = localStorage.getItem('member_records_order');
            const lockStatus = localStorage.getItem('member_records_locked');
            
            if (savedData) {
                db = JSON.parse(savedData);
                const order = JSON.parse(savedOrder) || Object.keys(db);
                order.forEach(id => { if(db[id]) createMemberElement(id, db[id].name); });
                if (order.length > 0) switchMember(document.querySelector('.member-item'), order[0]);
            } else {
                db = { 'm1': { name: 'COVER', photos: [], desc: 'é›™æ“Šå·¦å´æˆå“¡åå­—å¯ä»¥ä¿®æ”¹åç¨±ã€‚' } };
                saveToLocal();
                location.reload();
            }

            if (lockStatus === 'true') {
                applyFinalLock();
            } else {
                initSortable();
            }
        };

        function initSortable() {
            sortable = Sortable.create(document.getElementById('memberList'), {
                animation: 150,
                onEnd: () => { saveToLocal(); }
            });
        }

        function saveToLocal() {
            localStorage.setItem('member_records_db', JSON.stringify(db));
            const order = Array.from(document.querySelectorAll('.member-item')).map(el => el.getAttribute('data-id'));
            localStorage.setItem('member_records_order', JSON.stringify(order));
        }

        function createMemberElement(id, name) {
            const item = document.createElement('div');
            item.className = 'member-item';
            item.setAttribute('data-id', id);
            item.innerText = name;
            item.onclick = () => switchMember(item, id);
            
            // âœ¨ é›™æ“Šä¿®æ”¹åå­—åŠŸèƒ½ âœ¨
            item.ondblclick = () => {
                if (isLocked) return;
                const newName = prompt("è«‹è¼¸å…¥æ–°çš„æˆå“¡åç¨±ï¼š", db[id].name);
                if (newName !== null && newName.trim() !== "") {
                    db[id].name = newName.trim();
                    item.innerText = db[id].name;
                    if (curMemId === id) {
                        document.getElementById('canvasNameTag').innerText = db[id].name;
                    }
                    saveToLocal();
                }
            };

            document.getElementById('memberList').appendChild(item);
        }

        function addNewMember() {
            if(isLocked) return;
            const name = document.getElementById('newName').value.trim();
            if (!name) return;
            const id = 'm' + Date.now();
            db[id] = { name: name, photos: [], desc: '' };
            createMemberElement(id, name);
            switchMember(document.querySelector(`[data-id="${id}"]`), id);
            document.getElementById('newName').value = '';
            saveToLocal();
        }

        function switchMember(el, id) {
            document.querySelectorAll('.member-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            curMemId = id;
            curPhotoIdx = 0;
            renderPage();
        }

        function renderPage() {
            if(!curMemId || !db[curMemId]) return;
            const mem = db[curMemId];
            document.getElementById('canvasNameTag').innerText = mem.name;
            document.getElementById('textInp').value = mem.desc || '';
            const photoArea = document.getElementById('photoContent');
            if (mem.photos.length > 0) {
                photoArea.innerHTML = `<img src="${mem.photos[curPhotoIdx]}" class="full-img">`;
                document.getElementById('pageNumber').innerText = `${curPhotoIdx + 1} / ${mem.photos.length}`;
            } else {
                photoArea.innerHTML = `<span style="color:#444;">EMPTY</span>`;
                document.getElementById('pageNumber').innerText = `0 / 0`;
            }
            document.getElementById('prevBtn').disabled = (curPhotoIdx === 0 || mem.photos.length === 0);
            document.getElementById('nextBtn').disabled = (curPhotoIdx === mem.photos.length - 1 || mem.photos.length === 0);
        }

        async function handleBatchUpload(input) {
            if (isLocked || !input.files.length) return;
            for (const file of Array.from(input.files).sort((a,b)=>a.name.localeCompare(b.name))) {
                const url = await new Promise(res => {
                    const reader = new FileReader();
                    reader.onload = e => res(e.target.result);
                    reader.readAsDataURL(file);
                });
                db[curMemId].photos.push(url);
            }
            renderPage();
            saveToLocal();
            input.value = '';
        }

        function changePhotoIdx(dir) { curPhotoIdx += dir; renderPage(); }
        function syncMemberDesc() { if(!isLocked) { db[curMemId].desc = document.getElementById('textInp').value; saveToLocal(); } }
        function deleteCurrentPhoto() { 
            if (!isLocked && db[curMemId].photos.length > 0 && confirm('ç¢ºå®šåˆªé™¤é€™å¼µç…§ç‰‡ï¼Ÿ')) { 
                db[curMemId].photos.splice(curPhotoIdx, 1); 
                if (curPhotoIdx > 0) curPhotoIdx--; 
                renderPage(); saveToLocal();
            } 
        }

        function finalLock() {
            if (confirm('âš ï¸ æ°¸ä¹…ç¢ºèªé–å®šï¼Ÿ\né–å®šå¾Œå°‡ç„¡æ³•å†æ›´åã€ç„¡æ³•æ–°å¢æˆå“¡ã€ç„¡æ³•åŒ¯å…¥ç…§ç‰‡ã€‚')) {
                isLocked = true;
                localStorage.setItem('member_records_locked', 'true');
                applyFinalLock();
            }
        }

        function applyFinalLock() {
            isLocked = true;
            document.getElementById('mainBody').classList.add('is-locked');
            document.getElementById('textInp').readOnly = true;
            if (sortable) sortable.option("disabled", true);
        }

        function exportJSON() {
            const order = Array.from(document.querySelectorAll('.member-item')).map(el => el.getAttribute('data-id'));
            const dataStr = JSON.stringify({ db, order, locked: isLocked });
            const blob = new Blob([dataStr], { type: "application/json" });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Archive_${new Date().toLocaleDateString()}.json`;
            a.click();
        }

        function importJSON(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const imported = JSON.parse(e.target.result);
                db = imported.db;
                localStorage.setItem('member_records_db', JSON.stringify(db));
                localStorage.setItem('member_records_order', JSON.stringify(imported.order));
                localStorage.setItem('member_records_locked', imported.locked || 'false');
                location.reload();
            };
            reader.readAsText(file);
        }

        async function exportPDF() {
            const zone = document.getElementById('print-zone');
            zone.innerHTML = '';
            const order = Array.from(document.querySelectorAll('.member-item')).map(el => el.getAttribute('data-id'));
            order.forEach(id => {
                db[id].photos.forEach((picUrl, index) => {
                    const p = document.createElement('div');
                    p.style.cssText = `width:900px; height:1180px; background:#000; padding:40px; position:relative; page-break-after:always; display:flex; flex-direction:column; align-items:center;`;
                    p.innerHTML = `<div style="width:100%; height:750px; position:relative; background:#000; border-radius:15px; overflow:hidden; border:1px solid #222;"><img src="${picUrl}" style="width:100%; height:100%; object-fit:contain;"><div class="name-tag">${db[id].name}</div><div class="page-info">${index+1} / ${db[id].photos.length}</div></div><div style="width:100%; margin-top:40px; padding:20px; color:#ccc; font-size:18px;">${db[id].desc}</div>`;
                    zone.appendChild(p);
                });
            });
            const opt = { margin: 0, filename: 'Archive.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, backgroundColor: '#000000' }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            await html2pdf().set(opt).from(zone).save();
        }
    </script>
</body>
</html>
